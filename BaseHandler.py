example_posts = [{"title": "Trump's Choice", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/kevin-mccarthy-trump-conflicts-of-interest_us_583dc491e4b06539a78a984d", "title": "PROBE-CRAZY GOP ON TRUMP CONFLICTS: CUT HIM SOME SLACK!", "image": "http://img.huffingtonpost.com/asset/622_350/583de7d11800007b14310759.jpeg?cache=h5u5h9hlut"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/29/us/politics/steven-terner-mnuchin-trump-treasury-secretary.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=a-lede-package-region&region=top-news&WT.nav=top-news", "title": "Steven Mnuchin Is Donald Trump\u2019s Expected Choice for Treasury Secretary", "image": "https://static01.nyt.com/images/2016/11/23/us/00mnuchin/00mnuchin-master768.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/29/heavy-lifting-ahead-as-trump-builds-national-security-team-from-ground-up.html", "title": "Heavy lifting ahead as Trump builds national security team from ground up", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/DONALDTRUMP397_20161129_155622.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/books/page-turner/ivanka-trumps-terrible-book-helps-explain-the-trump-family-ethos", "title": "Ivanka\u2019s Terrible, Revealing Book", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Tolentino-Ivanka-728x375-1480443597.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/big-government/2016/11/29/americas-economy-before-obama-versus-after-obama/", "title": "The Legacy: America\u2019s Economy Before Obama Versus After Obama", "image": "http://media.breitbart.com/media/2016/11/Obama-08-and16-AP-Reuters-420x315.jpg"}, "created": "Tue Nov 29 23:59:29 2016", "CNN": {"link": "http://www.cnn.com/2016/11/29/politics/trump-cabinet-women/index.html", "title": "The three women of color Trump has appointed, so far", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161129122102-seema-verma-nikki-haley-elaine-chao-composite-medium-tease.jpg"}}, {"title": "Recount", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/donald-trump-obama_us_583c8f01e4b06539a789ddd4", "title": "Trump Has Shown Receptiveness To Obama\u2019s Agenda. Does He Actually Mean It?", "image": "http://img.huffingtonpost.com/asset/scalefit_630_noupscale/583c90731a00002500cca17b.jpeg"}, "NewYorkTimes": {"link": "http://www.nytimes.com/interactive/2016/11/28/us/trump-tower-security.html?hp&action=click&pgtype=Homepage&clickSource=g-artboard%20g-artboard-v3%20&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "A Guide to White House North", "image": "https://static01.nyt.com/newsgraphics/2016/11/22/trump-in-nyc/713de4941a853d1f29706a59312d59e7fefc2d94/hp-promo-artboart.png"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/28/jill-stein-fighting-election-fraud-or-lining-her-own-pockets.html", "title": "Jill Stein -- Fighting election fraud or lining her own pockets?", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/trumpstein_20161128_180526.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/news/amy-davidson/another-call-for-a-recount", "title": "THE RECOUNT ROAD TO NOWHERE", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Davidson-AnotherCallforaRecount-728x375-1480357367.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/news/jill-stein-beats-deadline-in-pennsylvania-but-faces-uphill-battle-for-recount/", "title": "Did Jill Stein Get the 27,000 Affidavits Needed for a Pennsylvania Recount?", "image": "http://media.breitbart.com/media/2016/07/GettyImages-478193144-640x427.jpg"}, "created": "Tue Nov 29 23:56:36 2016", "CNN": {"link": "http://www.cnn.com/2016/11/28/us/ohio-state-university-active-shooter/index.html", "title": "Ohio State University: Attacker killed, 11 hospitalized after campus attack", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161128184001-t1-osu-suspect-inset-overlay-tease.jpg"}}, {"title": "Trump's Administration", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/house-conservatives-trump-spending_us_5835d96de4b000af95ed9231", "title": "House Conservatives Signal Donald Trump Won\u2019t Have A Blank Check", "image": "http://img.huffingtonpost.com/asset/622_350/58388eaf180000461230ff5a.jpeg?cache=s2qwhki4qd"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/25/world/europe/donald-trump-scotland-wall.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "Trump Built a Wall in Scotland, Then Sent Residents the Bill", "image": "https://static01.nyt.com/images/2016/11/24/world/24Scotland3/24Scotland3-master675.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/25/businesses-brace-for-trump-decision-on-h-1b-visas-in-wake-sessions-pick.html", "title": "Businesses brace for Trump decision on H-1B visas in wake of Sessions pick", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/trump-sessions-edit_20161125_142816.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/news/daily-comment/the-francois-fillon-experiment", "title": "THE FRAN\u00c7OIS FILLON EXPERIMENT", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Gopnik-TheFrancoisFillonExperiment-728x375-1479930797.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/2016-presidential-race/2016/11/25/donald-trump-meet-sheriff-david-clarke-plans-administration/", "title": "Law and Order: Trump to Meet with Sheriff David Clarke as He Plans Administration", "image": "http://media.breitbart.com/media/2016/11/GettyImages-577290342-640x480.jpg"}, "created": "Tue Nov 29 23:54:14 2016", "CNN": {"link": "http://www.cnn.com/2016/11/25/politics/mcfarland-to-join-trump-administration-flynn-tweets/index.html", "title": "McFarland, McGahn to join Trump administration", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161125132118-kt-mcfarland-file-overlay-tease.jpg"}}, {"title": "Turmp's Policies", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/donald-trump-conflict-of-interest_us_58349547e4b09b6055ff367d?ifouefrqr1away8pvi", "title": "Donald Trump Basically Says Conflicts Of Interest Aren\u2019t Illegal If The President Has Them", "image": "http://img.huffingtonpost.com/asset/622_350/5834a9df1700002500e7bea4.jpeg?cache=3jpmvguhkc"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/22/us/politics/donald-trump-visit.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "Donald Trump Seems to Retreat on Some Promises", "image": "https://static01.nyt.com/images/2016/11/23/us/23trump7_hp/23trump7_hp-largeHorizontal375.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/22/trump-cancels-meeting-with-failing-new-york-times-then-reverses-course.html", "title": "Trump reverses course on Clinton, defends Bannon during New York Times meeting", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/trumpatnytimes_20161122_154925.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/news/news-desk/trumps-ideas-man-for-hard-line-immigration-policy", "title": "TRUMP\u2019S IDEAS MAN FOR HARD-LINE IMMIGRATION POLICY", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Blitzer-TrumpsIdeasManForHardlineImmigrationPolicy-728x375-1479842040.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/big-government/2016/11/22/president-elect-donald-j-trump-praises-breitbart-news-network-its-a-pretty-big-thing/", "title": "President-Elect Donald J. Trump Praises Breitbart News Network: \u2018It\u2019s a Pretty Big Thing\u2019", "image": "http://media.breitbart.com/media/2016/11/GettyImages-621864768-640x479.jpg"}, "created": "Tue Nov 29 23:52:03 2016", "CNN": {"link": "http://www.cnn.com/2016/11/22/politics/donald-trump-climate-change-new-york-times/index.html", "title": "Trump admits 'some connectivity' between climate change and human activity", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161122160134-02-donald-trump-nty-1122-overlay-tease.jpg"}}, {"title": "Obama on Trump", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/obama-expanded-overtime-pay-for-millions-of-workers-trump-could-take-it-away_us_58334ba0e4b058ce7aac5ee5?42qscs7flhjxxbt9", "title": "President Obama Expanded Overtime Pay For Millions Of Workers. President Trump Could Take It Away.", "image": "http://img.huffingtonpost.com/asset/scalefit_630_noupscale/58334c7a1700002500e7ba9e.jpeg"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/21/us/many-in-milwaukee-neighborhood-didnt-vote-and-dont-regret-it.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "Many in Milwaukee Neighborhood Didn\u2019t Vote \u2014 and Don\u2019t Regret It", "image": "https://static01.nyt.com/images/2016/11/21/us/21novote1/21novote1-master768-v2.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/us/2016/11/21/at-least-six-children-killed-23-hurt-in-tennessee-school-bus-crash.html", "title": "At least six children killed, 23 hurt in Tennessee school bus crash", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/schoolbuscrash_20161121_191346.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/magazine/2016/11/28/obama-reckons-with-a-trump-presidency", "title": "Obama Reckons with a Trump Presidency", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/161128_r29100_rd-690x960-1479432238.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/big-journalism/2016/11/21/report-donald-trump-unloads-media-bigwigs-trump-tower-meeting/", "title": "Report: Donald Trump Unloads on Mainstream Media Bigwigs in Trump Tower Meeting", "image": "http://media.breitbart.com/media/2016/11/TrumpMSM-640x480.jpg"}, "created": "Tue Nov 29 23:35:23 2016", "CNN": {"link": "http://www.cnn.com/2016/11/21/us/tennessee-chattanooga-school-bus-accident/index.html", "title": "At least 6 dead in Chattanooga, Tennessee, school bus crash", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161121174805-chattanooga-bus-crash-overlay-tease.jpg"}}, {"title": "Clinton, FBI, emails", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/hillary-clinton-fbi-email_us_5813dbe4e4b0990edc316dd3", "title": "Hillary Clinton Demands FBI Release Any Information It Has On New Email Investigation", "image": "http://img.huffingtonpost.com/asset/622_350/5813e332190000a502c2fb65.jpeg"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/10/29/us/politics/fbi-hillary-clinton-email.html", "title": "Emails in Anthony Weiner Inquiry Jolt Hillary Clinton\u2019s Campaign", "image": "https://static01.nyt.com/images/2016/10/29/us/29EMAILSwebsub/29EMAILSwebsub-master675.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/10/28/lets-get-it-out-clinton-calls-on-fbi-to-release-info-on-email-investigation.html", "title": "Let's get it out': Clinton calls on FBI to release info on email investigation", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/clinton397_20161028_192945.jpg"}, "NewYorker": {"link": "http://www.breitbart.com/2016-presidential-race/2016/10/28/hillary-clinton-dismisses-fbi-investigation-rumors-hasty-press-conference/", "title": "Hillary Clinton Dismisses FBI Investigation \u2018Rumors\u2019 in Hasty Press Conference", "image": "http://media.breitbart.com/media/2016/10/AP_16302839783939-420x315.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/2016-presidential-race/2016/10/28/hillary-clinton-dismisses-fbi-investigation-rumors-hasty-press-conference/", "title": "Hillary Clinton Dismisses FBI Investigation \u2018Rumors\u2019 in Hasty Press Conference", "image": "http://media.breitbart.com/media/2016/10/AP_16302839783939-420x315.jpg"}, "created": "Tue Nov 29 23:32:57 2016", "CNN": {"link": "http://wgntv.com/2016/10/29/clinton-calls-on-fbi-to-release-full-and-complete-facts-of-email-review/", "title": "Clinton calls on FBI to release 'full and complete facts' of email review", "image": "http://i2.cdn.turner.com/cnnnext/dam/assets/161028194126-03-hillary-clinton-1028-overlay-tease.jpg"}}]

import os
import hmac
import logging

import webapp2
import jinja2

from google.appengine.api import memcache
from datetime import datetime, timedelta

from User import *
from Post import *
from Comment2 import *
from NewsArticle import *

# Set the template folder
template_dir = os.path.join( os.path.dirname(__file__), 'templates')

# For the jinja2 environment
jinja_env = jinja2.Environment( loader = jinja2.FileSystemLoader(template_dir), autoescape = True)

# keys - should be moved to other files
secret = 'cUPU9sx9AM'

# Cookie stuff
def make_secure_val(val):
    return '%s|%s' % (val, hmac.new(secret, val).hexdigest())

def check_secure_val(secure_val):
    val = secure_val.split('|')[0]
    if secure_val == make_secure_val(val):
        return val

# User stuff
def users_key(group = 'default'):
    return db.Key.from_path('users', group)

def make_salt(length = 5):
    return ''.join(random.choice(letters) for x in xrange(length))

def make_pw_hash(name, pw, salt = None):
    if not salt:
        salt = make_salt()
    h = hashlib.sha256(name + pw + salt).hexdigest()
    return '%s,%s' % (salt, h)

def valid_pw(name, password, h):
    salt = h.split(',')[0]
    return h == make_pw_hash(name, password, salt)

# Key stuff
def post_key(name = 'default'):
    return db.Key.from_path('posts', name)

def comment_key(name = 'default'):
    return db.Key.from_path('comments', name)

def comment2_key(name = 'default'):
    return db.Key.from_path('comments2', name)

def article_key(name = 'default'):
    return db.Key.from_path('articles', name)


# Memcache stuff
def age_set(key, val):
    save_time = datetime.utcnow()
    memcache.set(key, (val, save_time))

def age_get(key):
    r = memcache.get(key)
    if r:
        val, save_time = r
        age = (datetime.utcnow() - save_time).total_seconds()
    else:
        val, age = None, 0
    
    return val, age

def get_posts(update = False):
    mc_key = 'Post'
    posts, age = age_get(mc_key)
    
    if update or posts is None:
        query = Post.all().order('-created').fetch(limit=12)
        posts = list(query)
        
        if len(posts) == 0:
            posts, age = read_from_example()
        
        age_set(mc_key, posts)
    
    return posts, age

def add_post(post):
    post.put()
    get_posts(update = True)
    return str(post.key().id())

def get_comments(post_id, update = False):
    mc_key = 'Comment_' + post_id
    comments, age = age_get(mc_key)
    
    if update or comments is None:
        query = Comment.all().filter('post_id =', post_id).order('-created').fetch(limit=10)
        comments = list(query)
        age_set(mc_key, comments)
    
    return comments, age

def add_comment(comment):
    comment.put()
    mc_key = 'Comment_' + comment.post_id
    memcache.delete(mc_key)
    # get_comments(post_id = comment.post_id, update = True)
    
    return str(comment.key().id())

def get_comments2(article_id, update = False):
    mc_key = 'Comment2_' + article_id
    comments2, age = age_get(mc_key)
    
    if update or comments2 is None:
        query = Comment2.all().filter('article_id =', article_id).order('-created').fetch(limit=10)
        comments2 = list(query)
        age_set(mc_key, comments2)
    
    return comments2, age

def add_comment2(comment2):
    comment2.put()
    mc_key = 'Comment2_' + comment2.article_id
    memcache.delete(mc_key)
    # get_comments(post_id = comment.post_id, update = True)
    
    return str(comment2.key().id())

def get_articles(update = False):
    mc_key = 'NewsArticle'
    articles, age = age_get(mc_key)
    
    if update or articles is None:
        query = NewsArticle.all().order('-created').fetch(limit=12)
        articles = list(query)
        
        if len(articles) == 0:
            articles, age = read_from_example2()
        
        age_set(mc_key, articles)
    
    return articles, age

def add_article(article):
    article.put()
    get_articles(update = True)
    return str(article.key().id())

def read_from_example():
    for p in example_posts:
        post = Post(parent = post_key(), title = p['title'],
                    title_NYT = p['NewYorkTimes']['title'], link_NYT = p['NewYorkTimes']['link'], image_NYT = p['NewYorkTimes']['image'],
                    title_Huffington = p['HuffingtonPost']['title'], link_Huffington = p['HuffingtonPost']['link'], image_Huffington = p['HuffingtonPost']['image'],
                    title_CNN = p['CNN']['title'], link_CNN = p['CNN']['link'], image_CNN = p['CNN']['image'],
                    title_Fox = p['FoxNews']['title'], link_Fox = p['FoxNews']['link'], image_Fox = p['FoxNews']['image'],
                    title_Breitbart = p['Breitbart']['title'], link_Breitbart = p['Breitbart']['link'], image_Breitbart = p['Breitbart']['image'])
        add_post(post)
    
    posts, age = get_posts()
    
    return posts, age

def read_from_example2():
    key = '779097b9e35e46b0ac3db6fc358afced'
    sources = ['the-new-york-times', 'the-huffington-post', 'cnn']
    
    for source in sources:
        url = "https://newsapi.org/v1/articles?source=%s&apiKey=%s" % (source, key)
        response = urllib2.urlopen(url)
        data = json.loads(response.read())
        articles = data['articles']
        
        for article in articles:
            a = NewsArticle(parent = article_key(), title = article['title'],
                            source = source, url = article['url'], image = article['urlToImage'],
                            description = article['description'], score = 0.0)
            add_article(a)
                
    articles, age = get_articles()
    
    return articles, age

# Handler
class Handler(webapp2.RequestHandler):
    def write(self, *a, **kw):
        self.response.out.write(*a, **kw)
    
    def render_str(self, template, **params):
        t = jinja_env.get_template(template)
        return t.render(params)
    
    def render(self, template, **kw):
        self.write(self.render_str(template, **kw))
    
    def render_json(self, d):
        json_txt = json.dumps(d)
        self.response.headers['Content-Type'] = 'application/json; charset=UTF-8'
        self.write(json_txt)
    
    def set_secure_cookie(self, name, val):
        cookie_val = make_secure_val(val)
        self.response.headers.add_header('Set-Cookie', '%s=%s; Path=/' % (name, cookie_val))
    
    def read_secure_cookie(self, name):
        cookie_val = self.request.cookies.get(name)
        return cookie_val and check_secure_val(cookie_val)
    
    def login(self, user):
        self.set_secure_cookie('user_id', str(user.key().id()))
    
    def logout(self):
        self.response.headers.add_header('Set-Cookie', 'user_id=; Path=/')
    
    def initialize(self, *a, **kw):
        webapp2.RequestHandler.initialize(self, *a, **kw)
        uid = self.read_secure_cookie('user_id')
        self.user = uid and User.by_id(int(uid))
        
        if self.request.url.endswith('.json'):
            self.format = 'json'
        else:
            self.format = 'html'
