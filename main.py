example_posts = [{"title": "Trump's Choice", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/kevin-mccarthy-trump-conflicts-of-interest_us_583dc491e4b06539a78a984d", "title": "PROBE-CRAZY GOP ON TRUMP CONFLICTS: CUT HIM SOME SLACK!", "image": "http://img.huffingtonpost.com/asset/622_350/583de7d11800007b14310759.jpeg?cache=h5u5h9hlut"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/29/us/politics/steven-terner-mnuchin-trump-treasury-secretary.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=a-lede-package-region&region=top-news&WT.nav=top-news", "title": "Steven Mnuchin Is Donald Trump\u2019s Expected Choice for Treasury Secretary", "image": "https://static01.nyt.com/images/2016/11/23/us/00mnuchin/00mnuchin-master768.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/29/heavy-lifting-ahead-as-trump-builds-national-security-team-from-ground-up.html", "title": "Heavy lifting ahead as Trump builds national security team from ground up", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/DONALDTRUMP397_20161129_155622.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/books/page-turner/ivanka-trumps-terrible-book-helps-explain-the-trump-family-ethos", "title": "Ivanka\u2019s Terrible, Revealing Book", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Tolentino-Ivanka-728x375-1480443597.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/big-government/2016/11/29/americas-economy-before-obama-versus-after-obama/", "title": "The Legacy: America\u2019s Economy Before Obama Versus After Obama", "image": "http://media.breitbart.com/media/2016/11/Obama-08-and16-AP-Reuters-420x315.jpg"}, "created": "Tue Nov 29 23:59:29 2016", "CNN": {"link": "http://www.cnn.com/2016/11/29/politics/trump-cabinet-women/index.html", "title": "The three women of color Trump has appointed, so far", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161129122102-seema-verma-nikki-haley-elaine-chao-composite-medium-tease.jpg"}}, {"title": "Recount", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/donald-trump-obama_us_583c8f01e4b06539a789ddd4", "title": "Trump Has Shown Receptiveness To Obama\u2019s Agenda. Does He Actually Mean It?", "image": "http://img.huffingtonpost.com/asset/scalefit_630_noupscale/583c90731a00002500cca17b.jpeg"}, "NewYorkTimes": {"link": "http://www.nytimes.com/interactive/2016/11/28/us/trump-tower-security.html?hp&action=click&pgtype=Homepage&clickSource=g-artboard%20g-artboard-v3%20&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "A Guide to White House North", "image": "https://static01.nyt.com/newsgraphics/2016/11/22/trump-in-nyc/713de4941a853d1f29706a59312d59e7fefc2d94/hp-promo-artboart.png"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/28/jill-stein-fighting-election-fraud-or-lining-her-own-pockets.html", "title": "Jill Stein -- Fighting election fraud or lining her own pockets?", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/trumpstein_20161128_180526.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/news/amy-davidson/another-call-for-a-recount", "title": "THE RECOUNT ROAD TO NOWHERE", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Davidson-AnotherCallforaRecount-728x375-1480357367.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/news/jill-stein-beats-deadline-in-pennsylvania-but-faces-uphill-battle-for-recount/", "title": "Did Jill Stein Get the 27,000 Affidavits Needed for a Pennsylvania Recount?", "image": "http://media.breitbart.com/media/2016/07/GettyImages-478193144-640x427.jpg"}, "created": "Tue Nov 29 23:56:36 2016", "CNN": {"link": "http://www.cnn.com/2016/11/28/us/ohio-state-university-active-shooter/index.html", "title": "Ohio State University: Attacker killed, 11 hospitalized after campus attack", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161128184001-t1-osu-suspect-inset-overlay-tease.jpg"}}, {"title": "Trump's Administration", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/house-conservatives-trump-spending_us_5835d96de4b000af95ed9231", "title": "House Conservatives Signal Donald Trump Won\u2019t Have A Blank Check", "image": "http://img.huffingtonpost.com/asset/622_350/58388eaf180000461230ff5a.jpeg?cache=s2qwhki4qd"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/25/world/europe/donald-trump-scotland-wall.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "Trump Built a Wall in Scotland, Then Sent Residents the Bill", "image": "https://static01.nyt.com/images/2016/11/24/world/24Scotland3/24Scotland3-master675.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/25/businesses-brace-for-trump-decision-on-h-1b-visas-in-wake-sessions-pick.html", "title": "Businesses brace for Trump decision on H-1B visas in wake of Sessions pick", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/trump-sessions-edit_20161125_142816.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/news/daily-comment/the-francois-fillon-experiment", "title": "THE FRAN\u00c7OIS FILLON EXPERIMENT", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Gopnik-TheFrancoisFillonExperiment-728x375-1479930797.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/2016-presidential-race/2016/11/25/donald-trump-meet-sheriff-david-clarke-plans-administration/", "title": "Law and Order: Trump to Meet with Sheriff David Clarke as He Plans Administration", "image": "http://media.breitbart.com/media/2016/11/GettyImages-577290342-640x480.jpg"}, "created": "Tue Nov 29 23:54:14 2016", "CNN": {"link": "http://www.cnn.com/2016/11/25/politics/mcfarland-to-join-trump-administration-flynn-tweets/index.html", "title": "McFarland, McGahn to join Trump administration", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161125132118-kt-mcfarland-file-overlay-tease.jpg"}}, {"title": "Turmp's Policies", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/donald-trump-conflict-of-interest_us_58349547e4b09b6055ff367d?ifouefrqr1away8pvi", "title": "Donald Trump Basically Says Conflicts Of Interest Aren\u2019t Illegal If The President Has Them", "image": "http://img.huffingtonpost.com/asset/622_350/5834a9df1700002500e7bea4.jpeg?cache=3jpmvguhkc"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/22/us/politics/donald-trump-visit.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "Donald Trump Seems to Retreat on Some Promises", "image": "https://static01.nyt.com/images/2016/11/23/us/23trump7_hp/23trump7_hp-largeHorizontal375.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/11/22/trump-cancels-meeting-with-failing-new-york-times-then-reverses-course.html", "title": "Trump reverses course on Clinton, defends Bannon during New York Times meeting", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/trumpatnytimes_20161122_154925.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/news/news-desk/trumps-ideas-man-for-hard-line-immigration-policy", "title": "TRUMP\u2019S IDEAS MAN FOR HARD-LINE IMMIGRATION POLICY", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/Blitzer-TrumpsIdeasManForHardlineImmigrationPolicy-728x375-1479842040.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/big-government/2016/11/22/president-elect-donald-j-trump-praises-breitbart-news-network-its-a-pretty-big-thing/", "title": "President-Elect Donald J. Trump Praises Breitbart News Network: \u2018It\u2019s a Pretty Big Thing\u2019", "image": "http://media.breitbart.com/media/2016/11/GettyImages-621864768-640x479.jpg"}, "created": "Tue Nov 29 23:52:03 2016", "CNN": {"link": "http://www.cnn.com/2016/11/22/politics/donald-trump-climate-change-new-york-times/index.html", "title": "Trump admits 'some connectivity' between climate change and human activity", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161122160134-02-donald-trump-nty-1122-overlay-tease.jpg"}}, {"title": "Obama on Trump", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/obama-expanded-overtime-pay-for-millions-of-workers-trump-could-take-it-away_us_58334ba0e4b058ce7aac5ee5?42qscs7flhjxxbt9", "title": "President Obama Expanded Overtime Pay For Millions Of Workers. President Trump Could Take It Away.", "image": "http://img.huffingtonpost.com/asset/scalefit_630_noupscale/58334c7a1700002500e7ba9e.jpeg"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/11/21/us/many-in-milwaukee-neighborhood-didnt-vote-and-dont-regret-it.html?hp&action=click&pgtype=Homepage&clickSource=story-heading&module=b-lede-package-region&region=top-news&WT.nav=top-news", "title": "Many in Milwaukee Neighborhood Didn\u2019t Vote \u2014 and Don\u2019t Regret It", "image": "https://static01.nyt.com/images/2016/11/21/us/21novote1/21novote1-master768-v2.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/us/2016/11/21/at-least-six-children-killed-23-hurt-in-tennessee-school-bus-crash.html", "title": "At least six children killed, 23 hurt in Tennessee school bus crash", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/schoolbuscrash_20161121_191346.jpg"}, "NewYorker": {"link": "http://www.newyorker.com/magazine/2016/11/28/obama-reckons-with-a-trump-presidency", "title": "Obama Reckons with a Trump Presidency", "image": "http://www.newyorker.com/wp-content/uploads/2016/11/161128_r29100_rd-690x960-1479432238.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/big-journalism/2016/11/21/report-donald-trump-unloads-media-bigwigs-trump-tower-meeting/", "title": "Report: Donald Trump Unloads on Mainstream Media Bigwigs in Trump Tower Meeting", "image": "http://media.breitbart.com/media/2016/11/TrumpMSM-640x480.jpg"}, "created": "Tue Nov 29 23:35:23 2016", "CNN": {"link": "http://www.cnn.com/2016/11/21/us/tennessee-chattanooga-school-bus-accident/index.html", "title": "At least 6 dead in Chattanooga, Tennessee, school bus crash", "image": "http://i2.cdn.cnn.com/cnnnext/dam/assets/161121174805-chattanooga-bus-crash-overlay-tease.jpg"}}, {"title": "Clinton, FBI, emails", "HuffingtonPost": {"link": "http://www.huffingtonpost.com/entry/hillary-clinton-fbi-email_us_5813dbe4e4b0990edc316dd3", "title": "Hillary Clinton Demands FBI Release Any Information It Has On New Email Investigation", "image": "http://img.huffingtonpost.com/asset/622_350/5813e332190000a502c2fb65.jpeg"}, "NewYorkTimes": {"link": "http://www.nytimes.com/2016/10/29/us/politics/fbi-hillary-clinton-email.html", "title": "Emails in Anthony Weiner Inquiry Jolt Hillary Clinton\u2019s Campaign", "image": "https://static01.nyt.com/images/2016/10/29/us/29EMAILSwebsub/29EMAILSwebsub-master675.jpg"}, "FoxNews": {"link": "http://www.foxnews.com/politics/2016/10/28/lets-get-it-out-clinton-calls-on-fbi-to-release-info-on-email-investigation.html", "title": "Let's get it out': Clinton calls on FBI to release info on email investigation", "image": "http://a57.foxnews.com/www.foxnews.com/images/root_images/0/0/clinton397_20161028_192945.jpg"}, "NewYorker": {"link": "http://www.breitbart.com/2016-presidential-race/2016/10/28/hillary-clinton-dismisses-fbi-investigation-rumors-hasty-press-conference/", "title": "Hillary Clinton Dismisses FBI Investigation \u2018Rumors\u2019 in Hasty Press Conference", "image": "http://media.breitbart.com/media/2016/10/AP_16302839783939-420x315.jpg"}, "Breitbart": {"link": "http://www.breitbart.com/2016-presidential-race/2016/10/28/hillary-clinton-dismisses-fbi-investigation-rumors-hasty-press-conference/", "title": "Hillary Clinton Dismisses FBI Investigation \u2018Rumors\u2019 in Hasty Press Conference", "image": "http://media.breitbart.com/media/2016/10/AP_16302839783939-420x315.jpg"}, "created": "Tue Nov 29 23:32:57 2016", "CNN": {"link": "http://wgntv.com/2016/10/29/clinton-calls-on-fbi-to-release-full-and-complete-facts-of-email-review/", "title": "Clinton calls on FBI to release 'full and complete facts' of email review", "image": "http://i2.cdn.turner.com/cnnnext/dam/assets/161028194126-03-hillary-clinton-1028-overlay-tease.jpg"}}]

import os
import re
import random
import hashlib
import hmac
import logging
import json
import urllib2

import webapp2
import jinja2

from string import letters
from datetime import datetime, timedelta

from google.appengine.ext import db
from google.appengine.api import memcache

template_dir = os.path.join(os.path.dirname(__file__), 'templates')
jinja_env = jinja2.Environment(loader = jinja2.FileSystemLoader(template_dir), autoescape = True)

# keys - should be moved to other files
secret = 'cUPU9sx9AM'

# Functions not in Classes
# Cookie stuff
def make_secure_val(val):
    return '%s|%s' % (val, hmac.new(secret, val).hexdigest())
    
def check_secure_val(secure_val):
    val = secure_val.split('|')[0]
    if secure_val == make_secure_val(val):
        return val
        
# User stuff
def users_key(group = 'default'):
    return db.Key.from_path('users', group)
    
def make_salt(length = 5):
    return ''.join(random.choice(letters) for x in xrange(length))
    
def make_pw_hash(name, pw, salt = None):
    if not salt:
        salt = make_salt()
    h = hashlib.sha256(name + pw + salt).hexdigest()
    return '%s,%s' % (salt, h)
    
def valid_pw(name, password, h):
    salt = h.split(',')[0]
    return h == make_pw_hash(name, password, salt)

# Post stuff
def post_key(name = 'default'):
    return db.Key.from_path('posts', name)
	
# Comment stuff
def comment_key(name = 'default'):
    return db.Key.from_path('comments', name)
    
# Memcache stuff
def age_set(key, val):
    save_time = datetime.utcnow()
    memcache.set(key, (val, save_time))
    
def age_get(key):
    r = memcache.get(key)
    if r:
        val, save_time = r
        age = (datetime.utcnow() - save_time).total_seconds()
    else:
        val, age = None, 0
        
    return val, age

def read_from_example():
    for p in example_posts:
        post = Post(parent = post_key(), title = p['title'],
                    title_NewYorker = p['NewYorker']['title'], link_NewYorker = p['NewYorker']['link'], image_NewYorker = p['NewYorker']['image'],
                    title_NYT = p['NewYorkTimes']['title'], link_NYT = p['NewYorkTimes']['link'], image_NYT = p['NewYorkTimes']['image'],
                    title_Huffington = p['HuffingtonPost']['title'], link_Huffington = p['HuffingtonPost']['link'], image_Huffington = p['HuffingtonPost']['image'],
                    title_CNN = p['CNN']['title'], link_CNN = p['CNN']['link'], image_CNN = p['CNN']['image'],
                    title_Fox = p['FoxNews']['title'], link_Fox = p['FoxNews']['link'], image_Fox = p['FoxNews']['image'],
                    title_Breitbart = p['Breitbart']['title'], link_Breitbart = p['Breitbart']['link'], image_Breitbart = p['Breitbart']['image'])
        add_post(post)
        
    posts, age = get_posts()
    
    return posts, age
    
def get_posts(update = False):
    mc_key = 'Post'  
    posts, age = age_get(mc_key)
    
    if update or posts is None:
        query = Post.all().order('-created').fetch(limit=5)
        posts = list(query)
        
        if len(posts) == 0:
            posts, age = read_from_example()
            
        age_set(mc_key, posts)
            
    return posts, age

def add_post(post):
    post.put()
    get_posts(update = True)
    return str(post.key().id())

def get_comments(post_id, update = False):
    mc_key = 'Comment_' + post_id
    comments, age = age_get(mc_key)
   
    if update or comments is None:
        query = Comment.all().filter('post_id =', post_id).order('-created').fetch(limit=10)
        comments = list(query)
        age_set(mc_key, comments)
        
    return comments, age
    
def add_comment(comment):
    comment.put()
    get_comments(post_id = comment.post_id, update = True)

    return str(comment.key().id())

# Class for User
class User(db.Model):
    name = db.StringProperty(required = True)
    pw_hash = db.StringProperty(required = True)
    email = db.StringProperty()
    
    @classmethod
    def by_id(cls, uid):
    	return User.get_by_id(uid, parent = users_key())
    	
    @classmethod
    def by_name(cls, name):
        return User.all().filter('name =', name).get()
    
    @classmethod
    def register(cls, name, pw, email = None):
        pw_hash = make_pw_hash(name, pw)
        return User(parent = users_key(), name = name, pw_hash = pw_hash, email = email)
    	
    @classmethod
    def login(cls, name, pw):
        u = cls.by_name(name)
        if u and valid_pw(name, pw, u.pw_hash):
            return u
            

# Class for Post
class Post(db.Model):
    # Title & Date and Time for a post
    title = db.StringProperty(required = True)
    created = db.DateTimeProperty(auto_now_add = True)

    # Links to articles and images
    title_NewYorker = db.StringProperty(required = True)
    link_NewYorker = db.LinkProperty(required = True)
    image_NewYorker = db.LinkProperty(required = True)

    title_NYT = db.StringProperty(required = True)
    link_NYT = db.LinkProperty(required = True)
    image_NYT = db.LinkProperty(required = True)

    title_Huffington = db.StringProperty(required = True)
    link_Huffington = db.LinkProperty(required = True)
    image_Huffington = db.LinkProperty(required = True)

    title_CNN = db.StringProperty(required = True)
    link_CNN = db.LinkProperty(required = True)
    image_CNN = db.LinkProperty(required = True)

    title_Fox = db.StringProperty(required = True)
    link_Fox = db.LinkProperty(required = True)
    image_Fox = db.LinkProperty(required = True)

    title_Breitbart = db.StringProperty(required = True)
    link_Breitbart = db.LinkProperty(required = True)
    image_Breitbart = db.LinkProperty(required = True)

    def as_dict(self):
        time_fmt = '%c'
        d = {'title': self.title,
             'NewYorker': {'title': self.title_NewYorker, 'link': self.link_NewYorker, 'image': self.image_NewYorker},
             'NewYorkTimes': {'title': self.title_NYT, 'link': self.link_NYT, 'image': self.image_NYT},
             'HuffingtonPost': {'title': self.title_Huffington, 'link': self.link_Huffington, 'image': self.image_Huffington},
             'CNN': {'title': self.title_CNN, 'link': self.link_CNN, 'image': self.image_CNN},
             'FoxNews': {'title': self.title_Fox, 'link': self.link_Fox, 'image': self.image_Fox},
             'Breitbart': {'title': self.title_Breitbart, 'link': self.link_Breitbart, 'image': self.image_Breitbart},
             'created': self.created.strftime(time_fmt)}
        return d

# Class for Comment

class Comment(db.Model):
    created = db.DateTimeProperty(auto_now_add = True)
    user_id = db.StringProperty(required = True)
    username = db.StringProperty(required = True)
    post_id = db.StringProperty(required = True)
    comment = db.StringProperty(required = True) # Maximum length of a comment = 1500 bytes

    def as_dict(self):
        time_fmt = '%c'
        d = {'user_id': self.user_id, 'username': self.username, 'post_id': self.post_id, 'created': self.created.strftime(time_fmt), 'comment': self.comment}
        return d

    
# Handler, probably no need to touch	
class Handler(webapp2.RequestHandler):
    def write(self, *a, **kw):
        self.response.out.write(*a, **kw)

    def render_str(self, template, **params):
        t = jinja_env.get_template(template)
        return t.render(params)

    def render(self, template, **kw):
        self.write(self.render_str(template, **kw))

    def render_json(self, d):
        json_txt = json.dumps(d)
        self.response.headers['Content-Type'] = 'application/json; charset=UTF-8'
        self.write(json_txt)

    def set_secure_cookie(self, name, val):
        cookie_val = make_secure_val(val)
        self.response.headers.add_header('Set-Cookie', '%s=%s; Path=/' % (name, cookie_val))

    def read_secure_cookie(self, name):
        cookie_val = self.request.cookies.get(name)
        return cookie_val and check_secure_val(cookie_val)

    def login(self, user):
        self.set_secure_cookie('user_id', str(user.key().id()))

    def logout(self):
        self.response.headers.add_header('Set-Cookie', 'user_id=; Path=/')

    def initialize(self, *a, **kw):
        webapp2.RequestHandler.initialize(self, *a, **kw)
        uid = self.read_secure_cookie('user_id')
        self.user = uid and User.by_id(int(uid))

        if self.request.url.endswith('.json'):
            self.format = 'json'
        else:
            self.format = 'html'
            
            
# Handler for Login
class Login(Handler):
    def get(self):
        self.render('login-form.html')

    def post(self):
        username = self.request.get('username')
        password = self.request.get('password')

        u = User.login(username, password)
        if u:
            self.login(u)
            self.redirect('/')
        else:
            msg = 'Invalid login'
            self.render('login-form.html', error = msg)
            
# Handler for Logout
class Logout(Handler):
    def get(self):
        self.logout()
        self.redirect('/')


# Handler for Signup page

USER_RE = re.compile(r"^[a-zA-Z0-9_-]{3,20}$")
def valid_username(username):
    return username and USER_RE.match(username)

PASS_RE = re.compile(r"^.{3,20}$")
def valid_password(password):
    return password and PASS_RE.match(password)

EMAIL_RE  = re.compile(r'^[\S]+@[\S]+\.[\S]+$')
def valid_email(email):
    return not email or EMAIL_RE.match(email)
    
class Signup(Handler):
    def get(self):
        self.render("signup-form.html")
        
    def post(self):
        have_error = False
        self.username = self.request.get('username')
        self.password = self.request.get('password')
        self.verify = self.request.get('verify')
        self.email = self.request.get('email')
        
        params = dict(username = self.username, email = self.email)
        
        if not valid_username(self.username):
            params['error_username'] = "Invalid username."
            have_error = True
            
        if not valid_password(self.password):
            params['error_password'] = "Invalid password."
            have_error = True
        elif self.password != self.verify:
            params['error_verify'] = "The passwords didn't match."
            have_error = True
            
        if not valid_email(self.email):
            params['error_email'] = "Invaild email address."
            have_error = True
            
        if have_error:
            self.render("signup-form.html", **params)
        else:
            self.done()
            
    def done(self):
        u = User.by_name(self.username)
        if u:
            msg = "The user already exists."
            self.render('signup-form.html', error_username = msg)
        else:
            u = User.register(self.username, self.password, self.email)
            u.put()
            
            self.login(u)
            self.redirect('/')
            

# Handler for a comment page
class PostPage(Handler):
    def render_post(self, post_id = None, error = ""):
        postkey = 'POST_' + post_id
        post, age = age_get(postkey)
        
        if not post:
            key = db.Key.from_path('Post', int(post_id), parent = post_key())
            post = db.get(key)
            age_set(postkey, post)
            age = 0
        
        if not post:
            self.error(404)
            return
        elif self.format == 'html':
            comments, age = get_comments(post_id)
            logging.warning('Postpage %s' % len(comments))
            logging.warning('set %s' % len(list(Comment.all().filter('post_id =', post_id).order('-created').fetch(limit=10))) )
            
            if self.user:
                self.render("permalink.html", post = post, username = self.user.name, comments = comments, error = error)
            else:
                self.render("permalink.html", post = post, username = None, comments = comments, error = error)
        else:
            comments, age = get_comments(post_id)
            self.render_json([post.as_dict()] + [c.as_dict() for c in comments])

    
    def get(self, post_id):
        self.render_post(post_id = post_id)
    
    def post(self, post_id):
        error = ''
        comments = ''
        postkey = 'POST_' + post_id
        post, age = age_get(postkey)
        
        if self.user:
            username = self.request.get("username")
            if self.user.name == username:
                comment = self.request.get("comment")
                
                if comment:
                    c = Comment(parent = comment_key(), user_id = str(self.user.key().id()), username = username, post_id = str(post.key().id()), comment = comment)
                    add_comment(c)
                
                else:
                    error = 'Please write your comment.'
            else:
                error = "The username does not match."
                
        else:
            error = "Please login to submit your comment."
        
        self.render_post(post_id = post_id, error = error)

            
# Handler for a new post
def getarticles():
    key = '779097b9e35e46b0ac3db6fc358afced'
    sources = ['the-new-york-times', 'the-huffington-post', 'cnn']
    nyt = {}
    huffington = {}
    cnn = {}
    
    for source in sources:
        url = "https://newsapi.org/v1/articles?source=%s&apiKey=%s" % (source, key)
        response = urllib2.urlopen(url)
        data = json.loads(response.read())
        first = data['articles'][0]

        if source == 'the-new-york-times':
            nyt = first
        elif source == 'the-huffington-post':
            huffington = first
        elif source == 'cnn':
            cnn = first

    return (nyt, huffington, cnn)
            
        
class NewPost(Handler):
    def render_post(self, title="",
                    title_NewYorker = "", link_NewYorker = "", image_NewYorker = "",
                    title_NYT = "", link_NYT = "", image_NYT = "",
                    title_Huffington = "", link_Huffington = "", image_Huffington = "",
                    title_CNN = "", link_CNN = "", image_CNN = "",
                    title_Fox = "", link_Fox = "", image_Fox = "",
                    title_Breitbart = "", link_Breitbart = "" , image_Breitbart = "", error=""):
        self.render("newpost.html", title = title,
                    title_NewYorker = title_NewYorker, link_NewYorker = link_NewYorker, image_NewYorker = image_NewYorker,
                    title_NYT = title_NYT, link_NYT = link_NYT, image_NYT = image_NYT,
                    title_Huffington = title_Huffington, link_Huffington = link_Huffington, image_Huffington = image_Huffington,
                    title_CNN = title_CNN, link_CNN = link_CNN, image_CNN = image_CNN,
                    title_Fox = title_Fox, link_Fox = link_Fox, image_Fox = image_Fox,
                    title_Breitbart = title_Breitbart, link_Breitbart = link_Breitbart, image_Breitbart = image_Breitbart, error=error)

    def get(self):
        nyt, huffington, cnn = getarticles()
        self.render_post(title_NYT = nyt['title'], link_NYT = nyt['url'], image_NYT = nyt['urlToImage'],
                         title_Huffington = huffington['title'], link_Huffington = huffington['url'], image_Huffington = huffington['urlToImage'],
                         title_CNN = cnn['title'], link_CNN = cnn['url'], image_CNN = cnn['urlToImage'])

    def post(self):
        title = self.request.get("title")

        title_NewYorker = self.request.get("title_NewYorker")
        link_NewYorker = self.request.get("link_NewYorker")
        image_NewYorker = self.request.get("image_NewYorker")

        title_NYT = self.request.get("title_NYT")
        link_NYT = self.request.get("link_NYT")
        image_NYT = self.request.get("image_NYT")

        title_Huffington = self.request.get("title_Huffington")
        link_Huffington = self.request.get("link_Huffington")
        image_Huffington = self.request.get("image_Huffington")

        title_CNN = self.request.get("title_CNN")
        link_CNN = self.request.get("link_CNN")
        image_CNN = self.request.get("image_CNN")

        title_Fox = self.request.get("title_Fox")
        link_Fox = self.request.get("link_Fox")
        image_Fox = self.request.get("image_Fox")

        title_Breitbart = self.request.get("title_Breitbart")
        link_Breitbart = self.request.get("link_Breitbart")
        image_Breitbart = self.request.get("image_Breitbart")

        error = ""

        if title and link_NewYorker and image_NewYorker and link_NYT and image_NYT and link_Huffington and image_Huffington and link_CNN and image_CNN and link_Fox and image_Fox and link_Breitbart and image_Breitbart:
            post = Post(parent = post_key(), title = title,
                        title_NewYorker = title_NewYorker, link_NewYorker = link_NewYorker, image_NewYorker = image_NewYorker,
                        title_NYT = title_NYT, link_NYT = link_NYT, image_NYT = image_NYT,
                        title_Huffington = title_Huffington, link_Huffington = link_Huffington, image_Huffington = image_Huffington,
                        title_CNN = title_CNN, link_CNN = link_CNN, image_CNN = image_CNN,
                        title_Fox = title_Fox, link_Fox = link_Fox, image_Fox = image_Fox,
                        title_Breitbart = title_Breitbart, link_Breitbart = link_Breitbart, image_Breitbart = image_Breitbart)
            post_id = add_post(post)
            self.redirect('post/%s' % post_id)
        else:
            error = "Invalid input!!!"
            self.render_post(title = title,
                             title_NewYorker = title_NewYorker, link_NewYorker = link_NewYorker, image_NewYorker = image_NewYorker,
                             title_NYT = title_NYT, link_NYT = link_NYT, image_NYT = image_NYT,
                             title_Huffington = title_Huffington, link_Huffington = link_Huffington, image_Huffington = image_Huffington,
                             title_CNN = title_CNN, link_CNN = link_CNN, image_CNN = image_CNN,
                             title_Fox = title_Fox, link_Fox = link_Fox, image_Fox = image_Fox,
                             title_Breitbart = title_Breitbart, link_Breitbart = link_Breitbart, image_Breitbart = image_Breitbart,
                             error=error)

# Handler for the main page

class MainPage(Handler):
    def get(self):
        posts, age = get_posts()
        error = ''

        if self.format == 'html':
            logging.warning('Mainpage %s' % len(posts))
            logging.warning('Mset %s' % len(list(Post.all()) ))
            if self.user:
                self.render('content.html', posts = posts, username = self.user.name, error = error)
            else:
                self.render('content.html', posts = posts, username = None, error = error)
        else:
            return self.render_json([p.as_dict() for p in posts])


app = webapp2.WSGIApplication([('/?(?:.json)?', MainPage),
                               ('/signup',Signup),
                               ('/login',Login),
                               ('/logout',Logout),
                               ('/newpost', NewPost),
                               ('/post/([0-9]+)(?:.json)?', PostPage)],
                              debug=True)

